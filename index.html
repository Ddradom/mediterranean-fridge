<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Mediterranean Fridge</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #10B981; /* Emerald */
            --color-secondary: #F59E0B; /* Amber */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* Light background */
            min-height: 100vh;
        }
        .recipe-card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease-in-out;
        }
        .recipe-card:hover {
            transform: translateY(-2px);
        }
        .btn-primary {
            background-color: var(--color-primary);
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #059669; /* Darker emerald */
        }
        /* Custom scrollbar for better look */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: var(--color-primary);
            border-radius: 10px;
        }
        .like-button {
            transition: color 0.1s, transform 0.1s;
        }
        .like-button:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>

    <div class="max-w-7xl mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="text-center mb-12">
            <h1 class="text-5xl font-extrabold text-gray-800 mb-2">
                <span class="text-green-600">The</span> <span class="text-blue-600">Mediterranean</span> Fridge
            </h1>
            <p class="text-xl text-gray-500">Discover healthy meals using what you already have!</p>
            <div id="user-info" class="mt-4 text-sm text-gray-400">
                Loading user...
            </div>
        </header>

        <!-- Main Generation Section -->
        <section class="bg-white p-6 md:p-10 rounded-xl shadow-2xl mb-12 border-t-4 border-green-500">
            <h2 class="text-3xl font-bold text-gray-700 mb-6">What's in Your Fridge?</h2>
            <textarea id="ingredients-input" rows="3" class="w-full p-4 border-2 border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 resize-none text-gray-700" placeholder="e.g., 'Canned chickpeas, lemon, olive oil, cucumber, fresh parsley, half a red onion'"></textarea>

            <button id="generate-button" class="btn-primary w-full mt-4 py-3 rounded-lg text-white font-semibold text-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50 transition duration-150 ease-in-out" onclick="generateRecipe()">
                Generate My Mediterranean Meal
            </button>

            <!-- Loading & Error Indicator -->
            <div id="loading-indicator" class="mt-4 text-center hidden">
                <div class="animate-spin inline-block w-8 h-8 border-4 border-green-500 border-t-transparent rounded-full"></div>
                <p class="text-gray-500 mt-2">Searching for healthy inspiration...</p>
            </div>
            <p id="error-message" class="mt-4 text-red-600 font-medium hidden"></p>
        </section>

        <!-- Shared Recipes Section -->
        <section>
            <h2 class="text-3xl font-bold text-gray-700 mb-6 border-b pb-2">Shared Recipes</h2>
            <p class="text-gray-500 mb-4">View recipes generated by everyone who uses The Mediterranean Fridge! Like your favorites!</p>
            <div id="shared-recipes-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 custom-scrollbar max-h-[80vh] overflow-y-auto">
                <!-- Recipes will be injected here -->
            </div>
            <p id="no-recipes-message" class="text-center text-gray-400 py-10 hidden">No recipes have been generated yet. Be the first!</p>
        </section>

        <!-- Custom Modal for Alerts/Confirmation (instead of alert/confirm) -->
        <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-6 w-full max-w-lg shadow-2xl">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-3">Notice</h3>
                <p id="modal-message" class="text-gray-600 mb-4"></p>
                <div class="flex justify-end space-x-3">
                    <!-- Confirm and Cancel buttons are hidden/repurposed when showing a recipe -->
                    <button id="modal-confirm" class="bg-green-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-600 transition duration-150">Close</button>
                    <button id="modal-cancel" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-lg font-semibold hover:bg-gray-400 transition duration-150 hidden">Cancel</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Firebase Module Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, serverTimestamp, setLogLevel, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let isAuthReady = false;

        // Set Firebase Log Level to Debug
        setLogLevel('debug');

        if (firebaseConfig) {
            // 1. Initialize Firebase
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            window.db = db; // Make db globally available for generateRecipe

            // 2. Handle Authentication
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                } else if (initialAuthToken) {
                    // Sign in with custom token if available
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        userId = auth.currentUser.uid;
                    } catch (error) {
                        console.error("Error signing in with custom token:", error);
                        // Fallback to anonymous sign-in on error
                        await signInAnonymously(auth);
                        userId = auth.currentUser.uid;
                    }
                } else {
                    // Sign in anonymously if no token is available (for development)
                    await signInAnonymously(auth);
                    userId = auth.currentUser.uid;
                }

                // Update UI with User ID
                document.getElementById('user-info').textContent = 'User ID: ' + userId;

                isAuthReady = true;
                console.log("Authentication ready. User ID:", userId);

                // Start listening for recipes once auth is ready
                listenForRecipes();
            });
        } else {
            document.getElementById('error-message').textContent = 'Firebase configuration is missing.';
            document.getElementById('error-message').classList.remove('hidden');
        }

        // --- New Function: Update Like Count in Firestore ---
        async function updateLikeCount(recipeId) {
            if (!db) {
                console.error("Firestore not initialized.");
                return;
            }

            const collectionPath = `artifacts/${appId}/public/data/recipes`;
            const recipeRef = doc(db, collectionPath, recipeId);
            
            try {
                // Use increment to safely increase the like count
                await updateDoc(recipeRef, {
                    likes: increment(1)
                });
                // Simple visual feedback (only lasts until next real-time update)
                const button = document.querySelector(`[data-recipe-id="${recipeId}"][data-action="like"]`);
                if (button) {
                    button.classList.add('text-red-500', 'font-bold');
                    button.innerHTML = `Liked! (${(parseInt(button.dataset.likes) || 0) + 1})`;
                }

            } catch (error) {
                console.error("Error updating likes:", error);
                document.getElementById('error-message').textContent = 'Failed to like recipe.';
                document.getElementById('error-message').classList.remove('hidden');
            }
        }
        window.updateLikeCount = updateLikeCount; // Expose globally

        // 3. Real-Time Data Listener (Firestore)
        function listenForRecipes() {
            if (!isAuthReady || !db) return;

            // Use the PUBLIC path for collaborative data: /artifacts/{appId}/public/data/{collectionName}
            const collectionPath = `artifacts/${appId}/public/data/recipes`;
            const recipesRef = collection(db, collectionPath);

            onSnapshot(recipesRef, (snapshot) => {
                const recipesContainer = document.getElementById('shared-recipes-container');
                recipesContainer.innerHTML = ''; // Clear existing content
                let recipes = [];

                snapshot.forEach(doc => {
                    const data = doc.data();
                    recipes.push({ id: doc.id, ...data });
                });

                // Sort by likes descending, then by timestamp descending
                recipes.sort((a, b) => {
                    const likesDiff = (b.likes || 0) - (a.likes || 0);
                    if (likesDiff !== 0) return likesDiff;
                    return (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0);
                });

                if (recipes.length === 0) {
                    document.getElementById('no-recipes-message').classList.remove('hidden');
                } else {
                    document.getElementById('no-recipes-message').classList.add('hidden');
                    recipes.forEach(recipe => {
                        recipesContainer.appendChild(createRecipeCard(recipe));
                    });
                }
            }, (error) => {
                console.error("Error listening to recipes:", error);
                document.getElementById('error-message').textContent = 'Failed to load shared recipes.';
                document.getElementById('error-message').classList.remove('hidden');
            });
        }

        // Helper function to create the recipe card element
        function createRecipeCard(recipe) {
            const card = document.createElement('div');
            card.className = 'recipe-card bg-white p-6 rounded-xl border border-gray-200 flex flex-col justify-between';
            const likes = recipe.likes || 0;

            // Find the title (usually the first line before the first markdown header)
            const titleMatch = recipe.recipeText.trim().match(/^([^\n]+)/);
            const recipeTitle = titleMatch ? titleMatch[1].trim().replace(/^#+\s*/, '') : 'Untitled Recipe';
            const recipeBody = recipe.recipeText.trim().substring(titleMatch ? titleMatch[0].length : 0).trim();

            // Format date
            const date = recipe.timestamp ? new Date(recipe.timestamp.seconds * 1000).toLocaleDateString() : 'Unknown Date';

            card.innerHTML = `
                <div>
                    <h3 class="text-2xl font-extrabold text-green-700 mb-2">${recipeTitle}</h3>
                    <p class="text-sm text-gray-500 mb-4 italic">Query: "${recipe.ingredientsQuery}"</p>
                    
                    <div class="prose max-w-none text-gray-700 overflow-hidden text-sm" style="max-height: 120px;">
                        <!-- Display only the first part of the recipe for summary -->
                        ${recipeBody.replace(/[\n\r]/g, '<br>')}
                    </div>
                </div>
                
                <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-100">
                    <span class="text-xs text-gray-400">By ${recipe.userId.substring(0, 8)}... on ${date}</span>
                    <div class="flex items-center space-x-3">
                        <button class="text-sm text-blue-600 hover:text-blue-800 font-semibold transition" onclick="showRecipeModal('${recipeTitle.replace(/'/g, "\\'")}', '${recipe.ingredientsQuery.replace(/'/g, "\\'")}', \`${recipeBody.replace(/`/g, '\\`')}\`, ${JSON.stringify(recipe.sources).replace(/'/g, "\\'")}, '${recipe.id}', ${likes})">
                            View
                        </button>
                        <button data-recipe-id="${recipe.id}" data-action="like" data-likes="${likes}" onclick="updateLikeCount('${recipe.id}')" class="like-button flex items-center text-gray-400 hover:text-red-500">
                            <span class="mr-1 text-red-500">${likes}</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 fill-current" viewBox="0 0 24 24">
                                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            return card;
        }

        // Expose functions globally for the button click and modal
        window.generateRecipe = generateRecipe;
        window.showRecipeModal = showRecipeModal;

        // Custom Modal Logic (for displaying full recipe)
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm');

        function showRecipeModal(title, query, recipeMarkdown, sources, recipeId, likes) {
            // Set modal content for displaying the full recipe
            modalTitle.textContent = title;
            
            let sourcesHtml = '';
            if (sources && sources.length > 0) {
                sourcesHtml = '<h4 class="text-lg font-bold mt-4 mb-2 text-gray-700">Sources:</h4><ul class="list-disc list-inside text-sm text-gray-500">';
                sources.forEach(source => {
                    if(source.uri && source.title) {
                        sourcesHtml += `<li><a href="${source.uri}" target="_blank" class="text-blue-500 hover:underline">${source.title}</a></li>`;
                    }
                });
                sourcesHtml += '</ul>';
            }

            // Enhanced Markdown to HTML Conversion
            const htmlContent = recipeMarkdown.split('\n').map(line => {
                line = line.trim();
                if (line.startsWith('### ')) return `<h5 class="text-xl font-semibold mt-4 mb-2 text-green-700">${line.substring(4)}</h5>`;
                if (line.startsWith('## ')) return `<h4 class="text-2xl font-bold mt-4 mb-2 text-green-700">${line.substring(3)}</h4>`;
                // List Items (both * and numbered)
                if (line.match(/^(\* |\d+\. )/)) return `<li class="ml-6 list-disc text-gray-700">${line.replace(/^(\* |\d+\. )/, '')}</li>`;
                // Bold/Italic (simple replacements)
                line = line.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>');
                if (line === '') return '';
                return `<p class="mb-2 text-gray-700">${line}</p>`;
            }).join('');

            const content = `
                <p class="text-sm italic text-gray-500 mb-4">Query: "${query}"</p>
                <div class="recipe-content p-4 bg-gray-50 rounded-lg border border-gray-200 custom-scrollbar max-h-96 overflow-y-auto">
                    ${htmlContent}
                </div>
                <div class="flex justify-between items-center mt-4">
                    <button data-recipe-id="${recipeId}" data-action="like" data-likes="${likes}" onclick="updateLikeCount('${recipeId}')" class="like-button flex items-center text-gray-400 hover:text-red-500 text-lg font-semibold">
                        <span class="mr-1 text-red-500">${likes}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 fill-current" viewBox="0 0 24 24">
                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                        </svg>
                        <span class="ml-1">Like This Recipe</span>
                    </button>
                    ${sourcesHtml}
                </div>
            `;
            
            modalMessage.innerHTML = content;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            modalConfirmBtn.textContent = 'Close';
            
            // Set the close handler
            modalConfirmBtn.onclick = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            };
        }

    </script>

    <!-- Main Application Logic (Gemini API & Firestore Save) -->
    <script>
        const GEMINI_MODEL = 'gemini-2.5-flash-preview-09-2025';
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=`;
        const MAX_RETRIES = 5;

        // Exponential backoff utility for API calls
        async function fetchWithRetry(url, options, retries = 0) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response;
            } catch (error) {
                if (retries < MAX_RETRIES) {
                    const delay = Math.pow(2, retries) * 1000;
                    console.log(`Fetch failed. Retrying in ${delay / 1000}s... (Attempt ${retries + 1}/${MAX_RETRIES})`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries + 1);
                }
                throw error;
            }
        }

        async function generateRecipe() {
            const ingredientsInput = document.getElementById('ingredients-input').value.trim();
            const generateButton = document.getElementById('generate-button');
            const loadingIndicator = document.getElementById('loading-indicator');
            const errorMessage = document.getElementById('error-message');
            
            errorMessage.classList.add('hidden');
            if (!ingredientsInput) {
                errorMessage.textContent = 'Please enter some ingredients you have!';
                errorMessage.classList.remove('hidden');
                return;
            }
            if (!window.db || !document.getElementById('user-info').textContent.includes('User ID:')) {
                errorMessage.textContent = 'Firebase is still loading. Please wait a moment.';
                errorMessage.classList.remove('hidden');
                return;
            }

            // UI State: Loading
            generateButton.disabled = true;
            generateButton.textContent = 'Generating...';
            loadingIndicator.classList.remove('hidden');
            
            const authId = document.getElementById('user-info').textContent.split(': ')[1];
            const systemPrompt = "You are 'The Mediterranean Fridge Chef AI.' Your goal is to generate a healthy, delicious, and easy-to-make Mediterranean meal based only on the ingredients provided. The recipe must be formatted clearly using Markdown with a Title (H1 or BOLD, no hashtags), followed by sections for Ingredients (H2/H3 list), and Step-by-Step Instructions (H2/H3 numbered list). Be enthusiastic and focus on fresh, healthy flavors. The response must start immediately with the recipe's title.";
            const userQuery = `Ingredients available in my fridge: ${ingredientsInput}. Generate one healthy Mediterranean recipe now.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                // Enable Google Search for grounding (finding real recipes/facts)
                tools: [{ "google_search": {} }], 
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await fetchWithRetry(API_URL, options);
                const result = await response.json();
                
                const candidate = result.candidates?.[0];
                if (!candidate || !candidate.content?.parts?.[0]?.text) {
                    throw new Error("Gemini API returned an invalid response structure.");
                }

                const recipeText = candidate.content.parts[0].text;
                
                // Extract grounding sources
                let sources = [];
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title); 
                }
                
                // Save the generated recipe to Firestore
                await saveRecipeToFirestore(ingredientsInput, recipeText, authId, sources);
                document.getElementById('ingredients-input').value = ''; // Clear input

            } catch (error) {
                console.error('Error generating or saving recipe:', error);
                errorMessage.textContent = 'Failed to generate recipe. Please try again.';
                errorMessage.classList.remove('hidden');
            } finally {
                // UI State: Done
                generateButton.disabled = false;
                generateButton.textContent = 'Generate My Mediterranean Meal';
                loadingIndicator.classList.add('hidden');
            }
        }

        async function saveRecipeToFirestore(query, text, userId, sources) {
            if (!window.db) {
                console.error("Firestore instance not available for saving.");
                return;
            }
            
            // Firestore imports are handled in the module script block
            const { addDoc, collection, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
            
            // Use the initialized Firestore instance directly (window.db is the db instance)
            const dbInstance = window.db; 
            
            // Note: __app_id is globally available from the Canvas environment
            const collectionPath = `artifacts/${__app_id}/public/data/recipes`;
            const recipesRef = collection(dbInstance, collectionPath);
            
            const recipeData = {
                ingredientsQuery: query,
                recipeText: text,
                userId: userId,
                timestamp: serverTimestamp(),
                sources: sources,
                likes: 0 // Initialize likes count
            };
            
            try {
                await addDoc(recipesRef, recipeData);
                console.log("Recipe successfully saved to Firestore.");
            } catch (error) {
                console.error("Error writing document: ", error);
                document.getElementById('error-message').textContent = 'Recipe generated, but failed to save to shared list.';
                document.getElementById('error-message').classList.remove('hidden');
            }
        }
    </script>
</body>
</html>