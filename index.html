<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>The Mediterranean Fridge AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --color-primary: #10B981; }
    body { 
      font-family: 'Inter', sans-serif; 
      background-color: #f7f9fb; 
      /* Subtle texture background for depth */
      background-image: linear-gradient(135deg, rgba(255,255,255,.2) 0%, rgba(240, 240, 240, .2) 100%);
      min-height: 100vh; 
    }
    .recipe-card { 
      box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
      border: 1px solid #e5e7eb;
      transition: transform 0.2s ease-in-out;
    }
    .recipe-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 30px rgba(0,0,0,0.15);
    }
    .main-button {
      background: linear-gradient(135deg, #10B981 0%, #059669 100%);
      box-shadow: 0 4px 10px rgba(16, 185, 129, 0.4);
      transition: all 0.2s ease-in-out;
    }
    .main-button:hover {
      background: linear-gradient(135deg, #059669 0%, #10B981 100%);
      box-shadow: 0 6px 15px rgba(16, 185, 129, 0.6);
      transform: translateY(-1px);
    }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #10B981;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .result-container {
      min-height: 400px;
    }
    .simulation-badge {
        position: absolute;
        top: -16px;
        right: -16px;
        transform: rotate(15deg);
        background-color: #f59e0b;
        color: white;
        padding: 4px 12px;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <div class="max-w-4xl mx-auto p-6 md:p-10">
    <header class="text-center mb-10">
      <h1 class="text-6xl font-extrabold text-gray-800 mb-2">
        <span class="text-green-600">The</span> <span class="text-blue-600">Mediterranean</span> AI Chef
      </h1>
      <p class="text-xl text-gray-500 font-light italic">
        Powered by Gemini: Crafting healthy meals from your fridge.
      </p>
    </header>

    <section class="bg-white p-6 rounded-2xl shadow-xl border-t-8 border-green-500 mb-8 relative">
      <h2 class="text-2xl font-bold text-gray-700 mb-4">What's in your fridge?</h2>
      <textarea id="ingredients-input" rows="3"
        class="w-full p-4 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-green-500 transition duration-150 text-base resize-none"
        placeholder="e.g., crab, couscous, olives, tomatoes, basil"></textarea>

      <div class="flex gap-3 mt-4">
        <button id="find-btn" class="main-button text-white py-3 rounded-lg font-semibold transition duration-150 flex items-center justify-center flex-1">
          <span id="find-btn-text">Generate Recipes with Gemini</span>
          <div id="loader" class="loader ml-3 hidden"></div>
        </button>
        <button id="clear-btn" class="px-6 py-3 rounded-lg border border-gray-300 bg-gray-100 hover:bg-gray-200 transition duration-150 font-medium">Clear</button>
      </div>

      <p id="hint" class="mt-3 text-sm text-gray-500">
        Tip: Include staples like olive oil, salt, and pepper for complete instructions.
      </p>
       <div id="mode-indicator" class="simulation-badge hidden">SIMULATION MODE ACTIVE</div>
    </section>

    <section id="results-section" class="result-container">
      <div id="results" class="grid grid-cols-1 gap-6">
        <!-- Recipes will be populated here -->
      </div>
      <p id="no-results" class="text-center text-gray-500 mt-6 hidden">Enter your ingredients to find a recipe!</p>
      <p id="error-message" class="text-center text-red-600 mt-6 hidden font-semibold bg-red-100 p-4 rounded-lg border border-red-300 shadow-md"></p>
    </section>

    <!-- Modal for full recipe view -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-8 w-full max-w-2xl shadow-2xl max-h-[90vh] overflow-y-auto relative">
            <h3 id="modal-title" class="text-3xl font-extrabold text-gray-800 mb-4 border-b pb-2"></h3>
            
            <div id="modal-content">
                <!-- Ingredients Section -->
                <div class="mb-6">
                    <h4 class="text-xl font-bold text-green-700 mb-3 flex items-center">Ingredients</h4>
                    <ul id="modal-ingredients-list" class="list-none space-y-2 text-gray-700 text-lg"></ul>
                </div>

                <!-- Steps Section -->
                <div>
                    <h4 class="text-xl font-bold text-blue-700 mb-3 flex items-center">Instructions</h4>
                    <ol id="modal-steps-list" class="list-decimal list-inside space-y-3 text-gray-700 text-base pl-4"></ol>
                </div>
            </div>

            <div class="mt-6 text-right">
                <button id="modal-close" class="px-4 py-2 rounded-lg border border-gray-300 bg-gray-100 hover:bg-gray-200 transition duration-150 font-medium">Close</button>
            </div>
        </div>
    </div>


    <footer class="mt-12 text-sm text-gray-500 text-center">
      <p>&copy; 2025 AI Recipe Generator. Always check cooking safety guidelines.</p>
    </footer>
  </div>

<script>
// =========================================================================
// CRITICAL FLAG: Set this to TRUE for guaranteed functional testing.
// If set to TRUE, the app bypasses the network and loads a simulated recipe.
const USE_API_SIMULATION = true; 
// =========================================================================

// --- API Configuration ---
const apiKey = ""; 
const apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";

// --- JSON Schema for Structured Output (Now requesting an ARRAY of recipes) ---
const singleRecipeSchema = {
    type: "OBJECT",
    properties: {
        "name": { "type": "STRING", "description": "A creative, unique name for the dish." },
        "ingredients": {
            "type": "ARRAY",
            "description": "List of required ingredients with quantities.",
            "items": {
                "type": "OBJECT",
                "properties": {
                    "item": { "type": "STRING", "description": "Name of the ingredient." },
                    "qty": { "type": "STRING", "description": "The quantity (e.g., '1 cup', '2 tbsp')." },
                    "note": { "type": "STRING", "description": "Preparation note (e.g., 'chopped', 'drained')." }
                },
                "required": ["item", "qty"]
            }
        },
        "steps": {
            "type": "ARRAY",
            "description": "Step-by-step cooking instructions.",
            "items": { "type": "STRING" }
        }
    },
    required: ["name", "ingredients", "steps"]
};

const recipeSchema = {
    type: "ARRAY",
    items: singleRecipeSchema,
    description: "An array containing 3 to 4 distinct Mediterranean recipes."
};

// --- DOM Elements ---
const inputEl = document.getElementById('ingredients-input');
const findBtn = document.getElementById('find-btn');
const clearBtn = document.getElementById('clear-btn');
const loaderEl = document.getElementById('loader');
const findBtnText = document.getElementById('find-btn-text');
const resultsEl = document.getElementById('results');
const noResultsEl = document.getElementById('no-results');
const errorEl = document.getElementById('error-message');
const modeIndicator = document.getElementById('mode-indicator');

// Modal Elements
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modal-title');
const modalIngredientsListEl = document.getElementById('modal-ingredients-list');
const modalStepsListEl = document.getElementById('modal-steps-list');
const modalCloseBtn = document.getElementById('modal-close');

// Initialize indicator visibility
if (USE_API_SIMULATION) {
    modeIndicator.classList.remove('hidden');
} else {
    modeIndicator.classList.add('hidden');
}


// --- Utility Functions ---

function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/[&<>"'`]/g, (s) => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;', '`':'&#96;' })[s]);
}

/**
 * Executes the API call with exponential backoff.
 */
async function fetchWithBackoff(payload, maxRetries = 5) {
    for (let i = 0; i < maxRetries; i++) {
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                return response.json();
            }

            if (response.status === 429 || response.status >= 500) {
                console.warn(`[Attempt ${i + 1}/${maxRetries}] Retrying due to status code: ${response.status}`);
                throw new Error(`API error ${response.status}: Retrying...`);
            } else {
                const errorBody = await response.json();
                console.error("Non-retriable API error details:", errorBody);
                throw new Error(errorBody.error?.message || `API failed with status: ${response.status}`);
            }

        } catch (error) {
            if (i === maxRetries - 1) {
                console.error("Final API call failed:", error.message);
                throw new Error(`Failed to fetch content after ${maxRetries} attempts. ${error.message}`);
            }
            const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
            await new Promise(resolve => setTimeout(resolve, delay));
        }
    }
}

/**
 * Provides a guaranteed JSON recipe ARRAY for simulation mode.
 */
function getSimulatedRecipes(ingredients) {
    const list = ingredients.split(',').map(s => s.trim().toLowerCase());
    const primaryIngredient = list.find(item => ['crab', 'chicken', 'tuna', 'shrimp'].includes(item)) || "Seafood";
    
    return [
        {
            name: `${primaryIngredient} & Lemon Orzo Skillet`,
            ingredients: [
                { item: primaryIngredient, qty: "300 g", note: "Cooked and flaked" },
                { item: "Orzo Pasta", qty: "1 cup", note: "Cooked" },
                { item: "Lemon", qty: "1", note: "Zested and juiced" },
                { item: "Spinach", qty: "2 cups", note: "Fresh" },
                { item: "Olive Oil", qty: "2 tbsp", note: "" },
                { item: "Garlic", qty: "2 cloves", note: "Minced" }
            ],
            steps: [
                "Sauté garlic in olive oil in a large skillet.",
                "Add cooked orzo, lemon zest, and lemon juice. Heat through.",
                "Stir in the spinach until wilted, then fold in the prepared " + primaryIngredient + ".",
                "Season with salt and pepper to taste and serve immediately."
            ]
        },
        {
            name: `Mediterranean ${primaryIngredient} & White Bean Salad`,
            ingredients: [
                { item: primaryIngredient, qty: "150 g", note: "Flaked or diced" },
                { item: "Canned White Beans", qty: "1 can", note: "Drained and rinsed" },
                { item: "Cherry Tomatoes", qty: "1 cup", note: "Halved" },
                { item: "Red Onion", qty: "1/4", note: "Thinly sliced" },
                { item: "Feta Cheese", qty: "50 g", note: "Crumbled" },
                { item: "Red Wine Vinegar", qty: "2 tbsp", note: "" },
                { item: "Dill", qty: "1 tbsp", note: "Fresh, chopped" }
            ],
            steps: [
                "Combine all solid ingredients (beans, tomatoes, onion, " + primaryIngredient + ", and dill) in a bowl.",
                "Whisk olive oil and red wine vinegar. Pour over salad and toss.",
                "Top with crumbled feta cheese and serve chilled."
            ]
        },
        {
            name: "Lemony Hummus Dip (Large Batch)",
            ingredients: [
                { item: "Canned Chickpeas", qty: "2 cans", note: "Drained, reserved liquid" },
                { item: "Tahini", qty: "1/2 cup", note: "" },
                { item: "Lemon Juice", qty: "3 tbsp", note: "Freshly squeezed" },
                { item: "Garlic", qty: "1 clove", note: "" },
                { item: "Ice Water", qty: "3 tbsp", note: "Or reserved chickpea liquid" }
            ],
            steps: [
                "Blend tahini, lemon juice, and garlic in a food processor until smooth.",
                "Add chickpeas, salt, and cumin (optional). Process until smooth.",
                "While blending, slowly drizzle in the ice water or reserved liquid until hummus is creamy.",
                "Serve drizzled with olive oil and paprika."
            ]
        }
    ];
}


/**
 * Generates the recipe using the Gemini API or Simulation.
 */
async function generateRecipes(ingredients) {
    console.log("--- Starting Recipe Generation ---");
    
    if (USE_API_SIMULATION) {
        console.warn("API Simulation is ACTIVE. Bypassing network call.");
        await new Promise(resolve => setTimeout(resolve, 800));
        const recipes = getSimulatedRecipes(ingredients);
        console.log("Simulation finished. Recipes:", recipes);
        return recipes;
    }

    const userPrompt = `Create 3 to 4 distinct recipes for Mediterranean dishes using primarily these ingredients: ${ingredients}. Focus on variety (e.g., one salad, one cooked dish, one dip).`;
    const systemPrompt = "You are a world-class Mediterranean chef. Generate an array of 3 to 4 complete recipes in the requested JSON structure. Include quantities, specific steps, and make sure the dishes strongly fit the Mediterranean diet principles.";

    const payload = {
        contents: [{ parts: [{ text: userPrompt }] }],
        systemInstruction: { parts: [{ text: systemPrompt }] },
        config: {
            responseMimeType: "application/json",
            responseSchema: recipeSchema
        }
    };

    try {
        const result = await fetchWithBackoff(payload);
        
        const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!jsonText) {
             console.error("Gemini Response was empty or malformed structure.", result);
             throw new Error("No structured content received from the model.");
        }
        
        let cleanedJsonText = jsonText.trim();
        cleanedJsonText = cleanedJsonText.replace(/^\s*```(json)?\s*/i, '').replace(/\s*```\s*$/i, '').trim();
        console.log("Raw JSON text:", jsonText);
        
        const recipeData = JSON.parse(cleanedJsonText);
        
        // Ensure the result is an array
        if (!Array.isArray(recipeData) || recipeData.length === 0) {
            throw new Error("Model returned structured data, but it was not a non-empty array of recipes.");
        }
        return recipeData;

    } catch (e) {
        throw new Error(`Failed to generate or parse recipe list. Parsing error: ${e.message}`);
    }
}

/**
 * Renders the generated array of recipes to the UI.
 * @param {object[]} recipes - An array of parsed recipe objects.
 */
function renderRecipes(recipes) {
    console.log("--- Starting Recipes Rendering ---");
    resultsEl.innerHTML = ''; // Clear previous results
    errorEl.classList.add('hidden');
    noResultsEl.classList.add('hidden');

    if (!Array.isArray(recipes) || recipes.length === 0) {
        noResultsEl.textContent = "No recipes were generated for these ingredients. Please try different items.";
        noResultsEl.classList.remove('hidden');
        return;
    }

    recipes.forEach((recipe, index) => {
        // Validation check for recipe structure
        if (!recipe || !recipe.name || !Array.isArray(recipe.ingredients)) {
            console.error(`Skipping recipe at index ${index} due to invalid structure:`, recipe);
            return;
        }

        const ingredientsSummary = recipe.ingredients
            .map(i => escapeHtml(i.item))
            .slice(0, 4)
            .join(', ');

        const card = document.createElement('div');
        card.className = 'recipe-card bg-white p-6 rounded-xl cursor-pointer';
        card.innerHTML = `
            <h3 class="text-xl font-bold text-gray-800 mb-2">${escapeHtml(recipe.name)}</h3>
            <p class="text-sm text-gray-600 mb-4">Includes: ${ingredientsSummary}...</p>
            <button data-recipe-index="${index}" class="view-recipe-btn text-blue-600 hover:text-blue-800 font-semibold text-sm">
                View Full Recipe »
            </button>
        `;
        resultsEl.appendChild(card);
    });

    // Attach click handler to all 'View Full Recipe' buttons
    document.querySelectorAll('.view-recipe-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.recipeIndex);
            showModal(recipes[index]);
        });
    });

    console.log(`--- ${recipes.length} Recipes Rendered Complete ---`);
}

/**
 * Displays the full recipe details in a modal.
 * @param {object} recipe - The recipe object to display.
 */
function showModal(recipe) {
    modalTitle.textContent = escapeHtml(recipe.name);
    modalIngredientsListEl.innerHTML = '';
    modalStepsListEl.innerHTML = '';

    // Render Ingredients
    recipe.ingredients.forEach(ing => {
        const li = document.createElement('li');
        const noteText = ing.note ? ` — ${escapeHtml(ing.note)}` : '';
        li.innerHTML = `<span class="text-green-500 mr-2">•</span> 
                        <span class="font-bold">${escapeHtml(ing.qty)}</span> 
                        <span class="ml-1">${escapeHtml(ing.item)}</span>
                        <span class="text-gray-500 italic ml-2 text-sm">${noteText}</span>`;
        modalIngredientsListEl.appendChild(li);
    });

    // Render Steps
    recipe.steps.forEach((step, index) => {
        const li = document.createElement('li');
        li.innerHTML = `<span class="font-semibold text-blue-800 mr-2">${index + 1}.</span> ${escapeHtml(step)}`;
        modalStepsListEl.appendChild(li);
    });

    modal.classList.remove('hidden');
    modal.style.display = 'flex';
}

// --- Modal Event Listeners ---
modalCloseBtn.addEventListener('click', () => {
    modal.classList.add('hidden');
    modal.style.display = 'none';
});


// --- Main Event Handlers ---

findBtn.addEventListener('click', async () => {
    const ingredients = inputEl.value.trim();

    resultsEl.innerHTML = '';
    errorEl.classList.add('hidden');
    noResultsEl.classList.add('hidden');

    if (ingredients.length < 5) {
        noResultsEl.textContent = "Please enter a list of ingredients (e.g., 'chicken, lemon, spinach').";
        noResultsEl.classList.remove('hidden');
        return;
    }

    // Show loading state
    loaderEl.classList.remove('hidden');
    findBtnText.textContent = 'Generating...';
    findBtn.disabled = true;

    try {
        const recipes = await generateRecipes(ingredients);
        renderRecipes(recipes);
    } catch (e) {
        errorEl.textContent = `Recipe generation failed: ${e.message}. (Check console for full debug info.)`;
        errorEl.classList.remove('hidden');
    } finally {
        // Hide loading state
        loaderEl.classList.add('hidden');
        findBtnText.textContent = 'Generate Recipes with Gemini';
        findBtn.disabled = false;
    }
});

clearBtn.addEventListener('click', () => {
    inputEl.value = '';
    resultsEl.innerHTML = '';
    errorEl.classList.add('hidden');
    noResultsEl.classList.remove('hidden');
    noResultsEl.textContent = "Enter your ingredients to find a recipe!";
    if (modal) {
        modal.classList.add('hidden');
        modal.style.display = 'none';
    }
});

// Initial state hint
document.addEventListener('DOMContentLoaded', () => {
    noResultsEl.textContent = "Enter your ingredients to find a recipe!";
    noResultsEl.classList.remove('hidden');
});
</script>
</body>
</html>
