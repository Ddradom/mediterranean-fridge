<script>
/* ============================
    SIMULATION: Expanded & Diverse Recipe Database
    ============================ */

/**
 * **SIMULATED** function to generate one custom recipe suggestion 
 * and return the full list of available recipes.
 * @param {string[]} fridgeItems - List of ingredients from the input.
 * @returns {Promise<Object>} An object containing the full recipe list and a suggested new recipe.
 */
async function generateRecipesWithGemini(fridgeItems) {
    // Simulate network latency
    await new Promise(resolve => setTimeout(resolve, 1500)); 

    // The comprehensive list of available recipes (used for display)
    const PLACEHOLDER_RECIPES = [
        {
            name: "Lemon & Herb Baked Salmon with Asparagus",
            ingredients: [
                { item: "salmon fillet", qty: "2", note: "about 150g each" },
                { item: "asparagus", qty: "1 bunch", note: "trimmed" },
                { item: "lemon", qty: "1", note: "sliced and juiced" },
                { item: "olive oil", qty: "2 tbsp", note: "" },
                { item: "garlic cloves", qty: "2", note: "minced" },
                { item: "dried oregano", qty: "1 tsp", note: "" }
            ],
            steps: [
                "Preheat oven to 400°F (200°C).",
                "Place salmon and asparagus on a baking sheet. Drizzle with olive oil, lemon juice, garlic, and oregano.",
                "Season with salt and pepper, then top salmon with lemon slices.",
                "Bake for 12–15 minutes, or until salmon is cooked through."
            ]
        },
        {
            name: "Mediterranean Quinoa Bowl with Feta",
            ingredients: [
                { item: "quinoa", qty: "1 cup", note: "cooked" },
                { item: "cucumber", qty: "1", note: "diced" },
                { item: "cherry tomatoes", qty: "1 cup", note: "halved" },
                { item: "feta cheese", qty: "75 g", note: "crumbled" },
                { item: "canned chickpeas", qty: "1/2 can", note: "drained and rinsed" },
                { item: "red wine vinegar", qty: "2 tbsp", note: "" },
                { item: "fresh parsley", qty: "1/4 cup", note: "chopped" }
            ],
            steps: [
                "In a large bowl, combine the cooked quinoa, cucumber, tomatoes, chickpeas, and parsley.",
                "Whisk together the olive oil, red wine vinegar, salt, and pepper for the dressing.",
                "Pour dressing over the bowl ingredients and toss gently.",
                "Sprinkle the crumbled feta cheese on top and serve."
            ]
        },
        {
            name: "Easy Hummus (from scratch or canned)",
            ingredients: [
                { item: "canned chickpeas", qty: "1 can (400g)", note: "drained (reserve liquid)" },
                { item: "tahini", qty: "1/4 cup", note: "" },
                { item: "lemon", qty: "1/2", note: "juiced" },
                { item: "garlic clove", qty: "1", note: "" },
                { item: "olive oil", qty: "2 tbsp", note: "extra virgin" }
            ],
            steps: [
                "Combine chickpeas, tahini, lemon juice, and garlic in a food processor.",
                "Blend until smooth, adding 1-2 tbsp of the reserved chickpea liquid (aquafaba) until desired consistency is reached.",
                "Season with salt. Transfer to a bowl, drizzle with olive oil, and serve with bread or vegetables."
            ]
        },
        {
            name: "Greek Yogurt & Cucumber Tzatziki Dip",
            ingredients: [
                { item: "Greek yogurt", qty: "1 cup", note: "plain, full-fat" },
                { item: "cucumber", qty: "1/2 medium", note: "grated and squeezed dry" },
                { item: "garlic clove", qty: "1", note: "minced" },
                { item: "fresh dill", qty: "1 tbsp", note: "chopped" },
                { item: "olive oil", qty: "1 tsp", note: "" }
            ],
            steps: [
                "Grate the cucumber and squeeze out as much water as possible using a paper towel or cheesecloth.",
                "In a bowl, mix the Greek yogurt, grated cucumber, minced garlic, and chopped dill.",
                "Season with salt and pepper. Stir in the olive oil.",
                "Refrigerate for at least 30 minutes to allow the flavors to combine."
            ]
        },
        {
            name: "Simple Chicken Souvlaki Skewers",
            ingredients: [
                { item: "chicken breast", qty: "450 g", note: "cut into 1-inch cubes" },
                { item: "olive oil", qty: "3 tbsp", note: "" },
                { item: "lemon", qty: "1", note: "juiced" },
                { item: "dried oregano", qty: "2 tsp", note: "" },
                { item: "garlic cloves", qty: "2", note: "crushed" }
            ],
            steps: [
                "Combine chicken cubes, olive oil, lemon juice, oregano, garlic, salt, and pepper in a bowl. Marinate for 30 minutes.",
                "Thread chicken onto skewers.",
                "Grill, bake, or pan-fry for 4-6 minutes per side, until chicken is cooked through and lightly browned.",
                "Serve immediately with a squeeze of fresh lemon."
            ]
        },
         {
            name: "Feta and Spinach Egg Scramble (Strapatsada)",
            ingredients: [
                { item: "eggs", qty: "3", note: "" },
                { item: "spinach", qty: "1 cup", note: "fresh or frozen, thawed" },
                { item: "feta cheese", qty: "50 g", note: "crumbled" },
                { item: "tomato", qty: "1/2", note: "diced" },
                { item: "olive oil", qty: "1 tsp", note: "" }
            ],
            steps: [
                "Heat olive oil in a pan. Sauté spinach and diced tomato until soft.",
                "Whisk eggs with salt, pepper, and oregano (optional).",
                "Pour eggs into the pan and cook, stirring occasionally, until almost set.",
                "Fold in the crumbled feta cheese and cook until the eggs are to your desired consistency."
            ]
        }
    ];
    
    // Custom recipe generation based on the input (simulated)
    const ingredientString = fridgeItems.join(', ');
    const customRecipeName = ingredientString.includes('chicken') && ingredientString.includes('rice') && ingredientString.includes('hummus') 
        ? "Gemini's Fusion: Chicken, Hummus & Tomato Rice Bowl"
        : "Gemini's Personalized Mediterranean Delight";
        
    const suggestedRecipe = {
        name: customRecipeName,
        ingredients: [
            { item: "Your Ingredients", qty: "", note: `Based on your list: ${ingredientString}` },
            { item: "Cooked Chicken", qty: "1 cup", note: "" },
            { item: "Basmati Rice", qty: "1 cup", note: "cooked" },
            { item: "Tomato", qty: "1 large", note: "diced" },
            { item: "Hummus", qty: "3 tbsp", note: "for topping" },
            { item: "Olive Oil", qty: "1 tbsp", note: "" },
            { item: "Lemon Juice", qty: "1 tsp", note: "" },
            { item: "Dried Oregano", qty: "1/2 tsp", note: "" }
        ],
        steps: [
            "Fluff the cooked rice. In a bowl, toss the rice with diced tomato, olive oil, lemon juice, and oregano.",
            "Warm the cooked chicken.",
            "Spoon the rice mixture into a serving bowl. Top with warm chicken.",
            "Garnish with a generous dollop of hummus and a sprinkle of salt/pepper. Serve warm."
        ]
    };

    // Return the full list for display AND the custom suggestion
    return { 
        fullList: PLACEHOLDER_RECIPES, 
        suggested: suggestedRecipe 
    };
}

/* ============================
    UI code (Modified to handle both full list and suggestion)
    ============================ */
const findBtn = document.getElementById('find-btn');
const clearBtn = document.getElementById('clear-btn');
const inputEl = document.getElementById('ingredients-input');
const resultsEl = document.getElementById('results');
const noResultsEl = document.getElementById('no-results');
const errorEl = document.getElementById('error-message');
const loaderEl = document.getElementById('loader');
const findBtnText = document.getElementById('find-btn-text');
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modal-title');
const modalBody = document.getElementById('modal-body');
const modalClose = document.getElementById('modal-close');

findBtn.addEventListener('click', async () => {
    const raw = inputEl.value;
    const list = raw.split(',').map(s => s.trim()).filter(Boolean);
    
    errorEl.classList.add('hidden');
    resultsEl.innerHTML = '';
    noResultsEl.classList.add('hidden');

    if (list.length === 0) {
        noResultsEl.textContent = "Please enter ingredients to see the suggested recipe and the full list.";
        noResultsEl.classList.remove('hidden');
        return;
    }

    loaderEl.classList.remove('hidden');
    findBtnText.textContent = 'Generating...';
    findBtn.disabled = true;

    try {
        const { fullList, suggested } = await generateRecipesWithGemini(list);
        renderSuggestedRecipe(suggested);
        renderFullList(fullList, [suggested]); // Pass suggested recipe so we can link the button
    } catch (e) {
        console.error("Gemini API simulation failed:", e);
        errorEl.classList.remove('hidden');
    } finally {
        loaderEl.classList.add('hidden');
        findBtnText.textContent = 'Find Recipes with Gemini';
        findBtn.disabled = false;
    }
});

clearBtn.addEventListener('click', () => {
    inputEl.value = '';
    resultsEl.innerHTML = '';
    noResultsEl.classList.add('hidden');
    errorEl.classList.add('hidden');
});

// New function to render the custom suggested recipe (the first card)
function renderSuggestedRecipe(recipe) {
    const suggestedSection = document.createElement('div');
    suggestedSection.className = 'bg-yellow-50 p-6 rounded-xl border border-yellow-200 mb-6';
    suggestedSection.innerHTML = `
        <h2 class="text-2xl font-bold text-yellow-800 mb-2 flex items-center">
            ✨ Gemini's Custom Suggestion
        </h2>
        <div id="suggested-recipe-card" class="recipe-card bg-white p-5 rounded-xl border border-yellow-300">
          <div class="flex justify-between items-start">
            <div class="flex-1 min-w-0">
              <h3 class="text-xl font-semibold text-gray-900 truncate">${escapeHtml(recipe.name)}</h3>
              <p class="text-sm text-gray-600 mt-1 line-clamp-2">A unique meal designed for your fridge contents!</p>
            </div>
            <div class="ml-4 flex-shrink-0">
              <button data-idx="0" class="view-suggested-btn text-sm font-medium text-blue-600 px-3 py-1 rounded-full border border-blue-100 bg-blue-50 hover:bg-blue-100 transition-colors">
                View Recipe
              </button>
            </div>
          </div>
        </div>
        <p class="text-sm text-yellow-700 mt-4">Below is the complete list of all available Mediterranean recipes.</p>
    `;
    resultsEl.appendChild(suggestedSection);

    // Attach click handler for the single suggested recipe
    suggestedSection.querySelector('.view-suggested-btn').addEventListener('click', () => {
        showModal(recipe);
    });
}

// New function to render the comprehensive list of all recipes
function renderFullList(recipes, prependedRecipes = []) {
    recipes.forEach((r, idx) => {
        const card = document.createElement('div');
        card.className = 'recipe-card bg-white p-5 rounded-xl border border-gray-100 hover:border-green-300 transition-shadow';

        const summary = `
          <div class="flex justify-between items-start">
            <div class="flex-1 min-w-0">
              <h3 class="text-xl font-semibold text-gray-900 truncate">${escapeHtml(r.name)}</h3>
              <p class="text-sm text-gray-600 mt-1 line-clamp-2">Key Ingredients: ${r.ingredients.map(i => escapeHtml(i.item)).slice(0, 4).join(', ')}...</p>
            </div>
            <div class="ml-4 flex-shrink-0">
              <button data-idx="${idx + prependedRecipes.length}" class="view-btn text-sm font-medium text-blue-600 px-3 py-1 rounded-full border border-blue-100 bg-blue-50 hover:bg-blue-100 transition-colors">
                View Recipe
              </button>
            </div>
          </div>
        `;
        card.innerHTML = summary;
        resultsEl.appendChild(card);
    });
    
    // Combine the prepended (suggested) recipe and the full list for modal lookup
    const allRecipes = [...prependedRecipes, ...recipes];

    // Attach click handlers for view buttons in the main list
    document.querySelectorAll('.view-btn').forEach((btn, index) => {
        btn.addEventListener('click', (e) => {
            // Note: We use the index of the button itself, not the data-idx, since we already added the suggested recipe above.
            // The index will correctly map to the item in the 'recipes' array passed to this function.
            showModal(recipes[index]); 
        });
    });
}

modalClose.addEventListener('click', () => { 
    modal.classList.add('hidden'); 
    modal.style.display = 'none';
});

function showModal(recipe) {
    modalTitle.textContent = recipe.name;
    let html = '<h4 class="font-bold text-green-600 border-b pb-1 mb-2">Ingredients</h4><ul class="list-disc list-inside text-gray-700 space-y-1">';
    recipe.ingredients.forEach(ing => {
        const note = ing.note ? ` — ${ing.note}` : '';
        html += `<li class="ml-4"><strong>${escapeHtml(ing.qty)}</strong> ${escapeHtml(ing.item)}<span class="text-gray-500 italic">${escapeHtml(note)}</span></li>`;
    });
    html += '</ul>';
    html += '<h4 class="font-bold text-green-600 border-b pb-1 mt-6 mb-2">Instructions</h4><ol class="list-decimal list-inside text-gray-700 space-y-3">';
    recipe.steps.forEach(step => {
        html += `<li class="ml-4">${escapeHtml(step)}</li>`;
    });
    html += '</ol>';
    modalBody.innerHTML = html;
    modal.classList.remove('hidden');
    modal.style.display = 'flex';
}

function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/[&<>"'`]/g, (s) => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;', '`':'&#96;' })[s]);
}
</script>
