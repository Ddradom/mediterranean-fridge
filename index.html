<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>The Mediterranean Fridge AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --color-primary: #10B981; }
    body { 
      font-family: 'Inter', sans-serif; 
      background-color: #f7f9fb; 
      /* Subtle texture background for depth */
      background-image: linear-gradient(135deg, rgba(255,255,255,.2) 0%, rgba(240, 240, 240, .2) 100%);
      min-height: 100vh; 
    }
    .recipe-card { 
      box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
      border: 1px solid #e5e7eb;
    }
    .main-button {
      background: linear-gradient(135deg, #10B981 0%, #059669 100%);
      box-shadow: 0 4px 10px rgba(16, 185, 129, 0.4);
      transition: all 0.2s ease-in-out;
    }
    .main-button:hover {
      background: linear-gradient(135deg, #059669 0%, #10B981 100%);
      box-shadow: 0 6px 15px rgba(16, 185, 129, 0.6);
      transform: translateY(-1px);
    }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #10B981;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .result-container {
      min-height: 400px;
    }
    .simulation-badge {
        position: absolute;
        top: -16px;
        right: -16px;
        transform: rotate(15deg);
        background-color: #f59e0b;
        color: white;
        padding: 4px 12px;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <div class="max-w-4xl mx-auto p-6 md:p-10">
    <header class="text-center mb-10">
      <h1 class="text-6xl font-extrabold text-gray-800 mb-2">
        <span class="text-green-600">The</span> <span class="text-blue-600">Mediterranean</span> AI Chef
      </h1>
      <p class="text-xl text-gray-500 font-light italic">
        Powered by Gemini: Crafting healthy meals from your fridge.
      </p>
    </header>

    <section class="bg-white p-6 rounded-2xl shadow-xl border-t-8 border-green-500 mb-8 relative">
      <h2 class="text-2xl font-bold text-gray-700 mb-4">What's in your fridge?</h2>
      <textarea id="ingredients-input" rows="3"
        class="w-full p-4 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-green-500 transition duration-150 text-base resize-none"
        placeholder="e.g., crab, couscous, olives, tomatoes, basil"></textarea>

      <div class="flex gap-3 mt-4">
        <button id="find-btn" class="main-button text-white py-3 rounded-lg font-semibold transition duration-150 flex items-center justify-center flex-1">
          <span id="find-btn-text">Generate Recipe with Gemini</span>
          <div id="loader" class="loader ml-3 hidden"></div>
        </button>
        <button id="clear-btn" class="px-6 py-3 rounded-lg border border-gray-300 bg-gray-100 hover:bg-gray-200 transition duration-150 font-medium">Clear</button>
      </div>

      <p id="hint" class="mt-3 text-sm text-gray-500">
        Tip: Include staples like olive oil, salt, and pepper for complete instructions.
      </p>
       <div id="mode-indicator" class="simulation-badge hidden">SIMULATION MODE ACTIVE</div>
    </section>

    <section id="results-section" class="result-container">
      <div id="results" class="hidden recipe-card bg-white p-8 rounded-2xl relative">
        <h2 id="recipe-name" class="text-3xl font-extrabold text-gray-800 mb-6 border-b-2 border-gray-100 pb-3"></h2>
        
        <!-- Ingredients Section -->
        <div class="mb-8">
          <h3 class="text-2xl font-bold text-green-700 mb-4 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-green-500"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M4 14v1a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3v-1"/></svg>
            Ingredients
          </h3>
          <ul id="ingredients-list" class="list-none space-y-3 text-gray-700 text-lg">
            <!-- Populated by JS -->
          </ul>
        </div>

        <!-- Steps Section -->
        <div>
          <h3 class="text-2xl font-bold text-blue-700 mb-4 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-blue-500"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6m-8 7h4m-4 4h4"/></svg>
            Instructions
          </h3>
          <ol id="steps-list" class="list-decimal list-inside space-y-4 text-gray-700 text-base pl-4">
            <!-- Populated by JS -->
          </ol>
        </div>

      </div>
      <p id="error-message" class="text-center text-red-600 mt-6 hidden font-semibold bg-red-100 p-4 rounded-lg border border-red-300 shadow-md"></p>
    </section>

    <footer class="mt-12 text-sm text-gray-500 text-center">
      <p>&copy; 2025 AI Recipe Generator. Always check cooking safety guidelines.</p>
    </footer>
  </div>

<script>
// =========================================================================
// CRITICAL FLAG: Set this to TRUE for guaranteed functional testing.
// If set to TRUE, the app bypasses the network and loads a simulated recipe.
const USE_API_SIMULATION = true; 
// =========================================================================

// --- API Configuration ---
const apiKey = ""; 
const apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";

// --- JSON Schema for Structured Output ---
const recipeSchema = {
    type: "OBJECT",
    properties: {
        "name": { "type": "STRING", "description": "A creative, unique name for the dish." },
        "ingredients": {
            "type": "ARRAY",
            "description": "List of required ingredients with quantities.",
            "items": {
                "type": "OBJECT",
                "properties": {
                    "item": { "type": "STRING", "description": "Name of the ingredient." },
                    "qty": { "type": "STRING", "description": "The quantity (e.g., '1 cup', '2 tbsp')." },
                    "note": { "type": "STRING", "description": "Preparation note (e.g., 'chopped', 'drained')." }
                },
                "required": ["item", "qty"]
            }
        },
        "steps": {
            "type": "ARRAY",
            "description": "Step-by-step cooking instructions.",
            "items": { "type": "STRING" }
        }
    },
    required: ["name", "ingredients", "steps"]
};

// --- DOM Elements ---
const inputEl = document.getElementById('ingredients-input');
const findBtn = document.getElementById('find-btn');
const clearBtn = document.getElementById('clear-btn');
const loaderEl = document.getElementById('loader');
const findBtnText = document.getElementById('find-btn-text');
const resultsEl = document.getElementById('results');
const errorEl = document.getElementById('error-message');
const recipeNameEl = document.getElementById('recipe-name');
const ingredientsListEl = document.getElementById('ingredients-list');
const stepsListEl = document.getElementById('steps-list');
const modeIndicator = document.getElementById('mode-indicator');

// Initialize indicator visibility
if (USE_API_SIMULATION) {
    modeIndicator.classList.remove('hidden');
} else {
    modeIndicator.classList.add('hidden');
}


// --- Utility Functions ---

function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/[&<>"'`]/g, (s) => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;', '`':'&#96;' })[s]);
}

/**
 * Executes the API call with exponential backoff.
 */
async function fetchWithBackoff(payload, maxRetries = 5) {
    // This function remains for API compatibility but is bypassed by simulation
    for (let i = 0; i < maxRetries; i++) {
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                return response.json();
            }

            if (response.status === 429 || response.status >= 500) {
                console.warn(`[Attempt ${i + 1}/${maxRetries}] Retrying due to status code: ${response.status}`);
                throw new Error(`API error ${response.status}: Retrying...`);
            } else {
                const errorBody = await response.json();
                console.error("Non-retriable API error details:", errorBody);
                throw new Error(errorBody.error?.message || `API failed with status: ${response.status}`);
            }

        } catch (error) {
            if (i === maxRetries - 1) {
                console.error("Final API call failed:", error.message);
                throw new Error(`Failed to fetch content after ${maxRetries} attempts. ${error.message}`);
            }
            const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
            await new Promise(resolve => setTimeout(resolve, delay));
        }
    }
}

/**
 * Provides a guaranteed JSON recipe for simulation mode.
 * @param {string} ingredients - User's input ingredients.
 * @returns {object} A mock recipe object.
 */
function getSimulatedRecipe(ingredients) {
    // FIX: Removed the extra ') after split(',
    const list = ingredients.split(',').map(s => s.trim().toLowerCase());
    const ingredientName = list.length > 0 ? list[0] : "Crab";
    const dishName = `Simulated Mediterranean ${ingredientName} & Couscous Salad`;

    return {
        name: dishName,
        ingredients: [
            { item: ingredientName, qty: "200 g", note: "Prepared or Cooked" },
            { item: "Couscous", qty: "1 cup", note: "Prepared according to package directions" },
            { item: "Kalamata Olives", qty: "1/4 cup", note: "Halved" },
            { item: "Cherry Tomatoes", qty: "1 cup", note: "Halved" },
            { item: "Feta Cheese", qty: "50 g", note: "Crumbled" },
            { item: "Olive Oil", qty: "3 tbsp", note: "Extra Virgin" },
            { item: "Lemon Juice", qty: "1 tbsp", note: "Freshly squeezed" },
            { item: "Fresh Mint", qty: "2 tbsp", note: "Chopped" }
        ],
        steps: [
            "Prepare the couscous and let it cool completely.",
            "In a large bowl, combine the cooked couscous, the prepared " + ingredientName + ", halved olives, cherry tomatoes, and mint.",
            "Whisk together the olive oil and lemon juice to form a vinaigrette. Season with salt and pepper.",
            "Pour the vinaigrette over the salad and toss gently to combine.",
            "Serve immediately or chill for 30 minutes to allow the flavors to meld. Top with crumbled feta."
        ]
    };
}


/**
 * Generates the recipe using the Gemini API or Simulation.
 * @param {string} ingredients - Comma-separated list of user ingredients.
 */
async function generateRecipe(ingredients) {
    console.log("--- Starting Recipe Generation ---");
    
    if (USE_API_SIMULATION) {
        console.warn("API Simulation is ACTIVE. Bypassing network call.");
        // Delay to show the loading indicator
        await new Promise(resolve => setTimeout(resolve, 800));
        const recipe = getSimulatedRecipe(ingredients);
        console.log("Simulation finished. Recipe:", recipe);
        return recipe;
    }

    const userPrompt = `Create a unique, detailed recipe for a dish in Mediterranean cuisine using primarily these ingredients: ${ingredients}. Please ensure the recipe is healthy and flavorful.`;
    const systemPrompt = "You are a world-class Mediterranean chef. Generate one complete recipe in the requested JSON structure. Include quantities, specific steps, and make sure the dish strongly fits the Mediterranean diet principles.";

    const payload = {
        contents: [{ parts: [{ text: userPrompt }] }],
        systemInstruction: { parts: [{ text: systemPrompt }] },
        config: {
            responseMimeType: "application/json",
            responseSchema: recipeSchema
        }
    };

    try {
        const result = await fetchWithBackoff(payload);
        
        const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!jsonText) {
             console.error("Gemini Response was empty or malformed structure.", result);
             throw new Error("No structured content received from the model.");
        }
        
        let cleanedJsonText = jsonText.trim();
        cleanedJsonText = cleanedJsonText.replace(/^\s*```(json)?\s*/i, '').replace(/\s*```\s*$/i, '').trim();
        console.log("Raw JSON text:", jsonText);
        
        const recipeData = JSON.parse(cleanedJsonText);
        return recipeData;

    } catch (e) {
        throw new Error(`Failed to generate or parse recipe. Parsing error: ${e.message}`);
    }
}

/**
 * Renders the generated recipe data to the UI.
 * @param {object} recipe - The parsed recipe object.
 */
function renderRecipe(recipe) {
    console.log("--- Starting Recipe Rendering ---");
    resultsEl.classList.remove('hidden');
    errorEl.classList.add('hidden');

    if (!recipe || !recipe.name || !Array.isArray(recipe.ingredients) || !Array.isArray(recipe.steps)) {
        console.error("Invalid recipe structure received:", recipe);
        errorEl.textContent = "The generated recipe structure was incomplete. Please try again or refine your ingredients.";
        errorEl.classList.remove('hidden');
        resultsEl.classList.add('hidden');
        return;
    }

    recipeNameEl.textContent = escapeHtml(recipe.name || 'Generated Mediterranean Dish');

    // Render Ingredients
    ingredientsListEl.innerHTML = '';
    recipe.ingredients.forEach(ing => {
        const li = document.createElement('li');
        li.className = 'flex items-start';
        
        const noteText = ing.note ? ` — ${escapeHtml(ing.note)}` : '';
        
        li.innerHTML = `<span class="text-green-500 mr-2">•</span> 
                        <span class="font-bold">${escapeHtml(ing.qty)}</span> 
                        <span class="ml-1">${escapeHtml(ing.item)}</span>
                        <span class="text-gray-500 italic ml-2 text-sm">${noteText}</span>`;
        ingredientsListEl.appendChild(li);
    });

    // Render Steps
    stepsListEl.innerHTML = '';
    recipe.steps.forEach((step, index) => {
        const li = document.createElement('li');
        li.innerHTML = `<span class="font-semibold text-blue-800 mr-2">${index + 1}.</span> ${escapeHtml(step)}`;
        stepsListList.appendChild(li);
    });
    console.log("--- Recipe Rendering Complete ---");
}

// --- Event Handlers ---

findBtn.addEventListener('click', async () => {
    const ingredients = inputEl.value.trim();

    resultsEl.classList.add('hidden');
    errorEl.classList.add('hidden');

    if (ingredients.length < 5) {
        errorEl.textContent = "Please enter a list of ingredients (e.g., 'chicken, lemon, spinach').";
        errorEl.classList.remove('hidden');
        return;
    }

    // Show loading state
    loaderEl.classList.remove('hidden');
    findBtnText.textContent = 'Generating...';
    findBtn.disabled = true;

    try {
        const recipe = await generateRecipe(ingredients);
        renderRecipe(recipe);
    } catch (e) {
        errorEl.textContent = `Recipe generation failed: ${e.message}. (Check console for full debug info.)`;
        errorEl.classList.remove('hidden');
    } finally {
        // Hide loading state
        loaderEl.classList.add('hidden');
        findBtnText.textContent = 'Generate Recipe with Gemini';
        findBtn.disabled = false;
    }
});

clearBtn.addEventListener('click', () => {
    inputEl.value = '';
    resultsEl.classList.add('hidden');
    errorEl.classList.add('hidden');
});
</script>
</body>
</html>
